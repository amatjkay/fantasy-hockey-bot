# Гайд по проекту Fantasy Hockey Bot

## Описание проекта
Fantasy Hockey Bot - это проект для автоматизации работы с фэнтези-хоккейной лигой ESPN. Бот собирает статистику игроков, формирует ежедневные команды лучших игроков и отправляет результаты в Telegram.

## Основные компоненты

### 1. Сервисы
- `ESPNService` - работа с API ESPN для получения статистики игроков
- `ImageService` - создание коллажей с изображениями игроков
- `TelegramService` - отправка сообщений и изображений в Telegram

### 2. Скрипты
- `app_day.py` - основной скрипт для формирования команды дня
- `collect_initial_stats.py` - сбор начальной статистики за сезон

### 3. Данные
Проект использует следующие файлы данных в директории `data/processed/`:
- `player_stats.json` - статистика игроков по неделям
- `season_stats.json` - статистика за весь сезон
- `teams_history.json` - история команд
- `weekly_team_stats.json` - статистика команд по неделям

## Основные функции

### Формирование команды дня
1. Получение статистики игроков за день через ESPN API
2. Проверка уникальности и корректности данных:
   - Пропуск существующих корректных данных
   - Перезапись некорректных или неполных данных
3. Выбор лучших игроков по total points:
   - При равном количестве очков выбор случайный
   - Всегда выбирается лучший доступный игрок из списка для каждой позиции
4. Состав команды:
   - 1 центральный нападающий (C)
   - 1 левый нападающий (LW)
   - 1 правый нападающий (RW)
   - 2 защитника (D)
   - 1 вратарь (G)

### Формирование команды недели
1. Анализ статистики игроков из ежедневных данных
2. Приоритеты при выборе игроков:
   - Первый приоритет: количество попаданий в команду дня
   - Второй приоритет: total points
3. Создание отдельного коллажа:
   - Формат аналогичен команде дня
   - Заголовок "Команда недели"
   - Указание дат периода (с-по)

### Формат коллажа команды дня
- Заголовок "Команда дня" и дата
- Для каждого игрока:
  - Качественное фото в формате PNG с прозрачным фоном
  - Стандартный размер изображения: 130x100 пикселей
  - Позиция игрока
  - Имя и фамилия
  - Total points за игровой день

### Система грейдов игроков
- Грейды сбрасываются каждый матчап (неделя с понедельника по воскресенье)
- Грейды присваиваются только при попадании в команду дня:
  - common (1 попадание)
  - uncommon (2 попадания)
  - rare (3 попадания)
  - epic (4 попадания)
  - legend (5+ попаданий)
- Грейды аккумулируются строго по дате в рамках одной недели
- Учитывается только основная позиция игрока
- Если игрок не попадал в команду дня, грейд не присваивается

## Настройка проекта

### Конфигурация
Проект использует многоуровневую систему конфигурации:

1. Базовый URL:
```
https://fantasy.espn.com/apis/v3/games/fhl/seasons/2025/segments/0/leagues/1
```

2. Конфигурационные файлы:
- `config/settings.py` - основные настройки
- `config/api_config.py` - настройки API
- `config/logging_config.py` - настройки логирования

### Режимы запуска
Скрипт `app_day.py` поддерживает следующие режимы:
```bash
# Стандартный запуск
python scripts/app_day.py

# Запуск за конкретную дату
python scripts/app_day.py --date YYYY-MM-DD

# Запуск с очисткой статистики
python scripts/app_day.py --clean

# Запуск с перезаписью данных за дату
python scripts/app_day.py --date YYYY-MM-DD --force

# Запуск в режиме дополнения данных
python scripts/app_day.py --append
```

### Зависимости
Установите необходимые зависимости:
```bash
pip install -r requirements.txt
```

#### Пример x-fantasy-filter (необходим для получения статистики)
```json
{
  "players": {
    "filterSlotIds": {
      "value": [0,1,2,3,4,6]
    },
    "filterStatsForCurrentSeasonScoringPeriodId": {
      "value": [78]
    },
    "sortPercOwned": {
      "sortPriority": 3,
      "sortAsc": false
    },
    "limit": 50,
    "offset": 0,
    "sortAppliedStatTotalForScoringPeriodId": {
      "sortAsc": false,
      "sortPriority": 1,
      "value": 78
    },
    "filterRanksForScoringPeriodIds": {
      "value": [78]
    },
    "filterRanksForRankTypes": {
      "value": ["STANDARD"]
    }
  }
}
```

### Маппинг позиций игроков
```
1: 'C'   # Center
2: 'LW'  # Left Wing
3: 'RW'  # Right Wing
4: 'D'   # Defense
5: 'G'   # Goalie
```

## Текущие проблемы и их решение

1. Проблемы с аутентификацией ESPN API:
   - Необходимо корректно передавать SWID и S2 токены
   - Требуется механизм обновления токенов
   - Нужна обработка ошибок аутентификации

2. Проблемы с форматированием запросов:
   - Некорректное формирование x-fantasy-filter
   - Отсутствие валидации параметров фильтра
   - Необходимость правильной сортировки результатов

3. SSL сертификаты:
   - Временно отключена проверка SSL
   - Необходимо реализовать корректную обработку сертификатов

## Рекомендации для следующего разработчика

### Первые шаги

1. Начните с исправления проблем в ESPNService:
   - Добавьте механизм повторных попыток при сбоях API
   - Реализуйте корректную обработку ошибок
   - Добавьте валидацию ответов от API

2. Реализуйте кэширование:
   - Кэширование запросов к API
   - Сохранение промежуточных результатов
   - Управление временем жизни кэша

3. Улучшите работу с фильтрами:
   - Создайте класс для построения x-fantasy-filter
   - Добавьте валидацию параметров
   - Реализуйте различные стратегии фильтрации

### Дальнейшие улучшения

1. Тестирование:
   - Добавьте модульные тесты для сервисов
   - Реализуйте интеграционные тесты
   - Добавьте мок-объекты для API

2. Мониторинг:
   - Добавьте метрики производительности
   - Реализуйте отслеживание ошибок
   - Настройте алерты при сбоях

3. Оптимизация:
   - Улучшите механизм сохранения данных
   - Оптимизируйте запросы к API
   - Добавьте параллельную обработку

## Текущие задачи

1. Исправление ESPNService:
   ```python
   def _make_request(self, params: Dict, headers: Dict) -> Optional[Dict]:
       # Добавить:
       # - Механизм повторных попыток
       # - Валидацию ответов
       # - Обработку ошибок SSL
   ```

2. Создание класса для фильтров:
   ```python
   class ESPNFantasyFilter:
       def __init__(self):
           self.filter = {"players": {}}
           
       def add_slot_filter(self, slots: List[int]):
           # Добавление фильтра по позициям
           
       def add_scoring_period_filter(self, period_id: int):
           # Добавление фильтра по периоду
   ```

3. Реализация кэширования:
   ```python
   class ESPNCache:
       def __init__(self, ttl: int = 3600):
           self.cache = {}
           self.ttl = ttl
           
       def get(self, key: str) -> Optional[Dict]:
           # Получение данных из кэша
           
       def set(self, key: str, value: Dict):
           # Сохранение данных в кэш
   ```

## Известные особенности API

1. Фильтры:
   - filterSlotIds: определяет позиции игроков
   - filterStatsForCurrentSeasonScoringPeriodId: период статистики
   - sortPercOwned: сортировка по популярности
   - filterRanksForRankTypes: тип рейтинга

### Важные моменты
1. **Структура данных**:
   - В `data/processed/` хранятся JSON файлы с историей команд и статистикой
   - Каждый файл имеет базовую структуру с ключами `weeks`, `players`, `teams`
   - При работе с файлами всегда проверяйте их существование и создавайте базовую структуру

2. **API ESPN**:
   - API требует аутентификации через `SWID` и `S2` токены
   - Используйте правильный `scoring_period_id` для получения статистики
   - Учитывайте часовой пояс лиги при работе с датами

3. **Обработка изображений**:
   - Изображения игроков кэшируются в `data/cache/player_images/`
   - Используйте системные шрифты для текста на коллажах
   - Проверяйте существование директорий перед сохранением

4. **Telegram**:
   - Бот использует длинные токены формата `123456789:AAA-BBB...`
   - ID чата может быть отрицательным для групповых чатов
   - Добавляйте повторные попытки при отправке сообщений

### Известные особенности
1. Сезон НХЛ 2024-25 начинается 4 октября 2024 года
2. День в системе начинается в 4 утра по времени лиги
3. Грейды игроков обновляются каждый понедельник
4. Команда дня формируется по следующим позициям:
   - 1 центральный нападающий (C)
   - 1 левый нападающий (LW)
   - 1 правый нападающий (RW)
   - 2 защитника (D)
   - 1 вратарь (G)

### Рекомендации по улучшению
1. Добавить тесты для критических компонентов
2. Реализовать механизм восстановления после сбоев
3. Добавить мониторинг производительности
4. Улучшить визуальное оформление коллажей
5. Добавить интерактивные команды в Telegram бота
6. Реализовать сравнение команд между разными неделями
7. Добавить статистику по дивизионам и конференциям

### Отладка
1. Используйте флаг `--no-send` для тестирования без отправки в Telegram
2. Проверяйте логи в директории `logs/`
3. При проблемах с API проверьте:
   - Валидность токенов
   - Правильность часового пояса
   - Корректность ID сезона и лиги

### Безопасность
1. Не коммитьте файл `.env` в репозиторий
2. Регулярно обновляйте токены API
3. Проверяйте права доступа к файлам с данными
4. Используйте безопасные методы хранения конфиденциальных данных 