# Гайд по проекту Fantasy Hockey Bot

## Описание проекта
Fantasy Hockey Bot - это проект для автоматизации работы с фэнтези-хоккейной лигой ESPN. Бот собирает статистику игроков, формирует ежедневные и еженедельные команды лучших игроков и отправляет результаты в Telegram.

## Основные компоненты

### 1. Сервисы
- `ESPNService` - работа с API ESPN для получения статистики игроков
- `ImageService` - создание коллажей с изображениями игроков
- `TelegramService` - отправка сообщений и изображений в Telegram
- `StatsService` - обработка и хранение статистики
- `CacheService` - кэширование данных

### 2. Скрипты
- `collect_and_send_stats.py` - сбор и отправка ежедневной статистики
- `rewrite_all_stats.py` - перезапись всей статистики с начала сезона
- `send_daily_teams.py` - формирование и отправка команд дня/недели
- `form_team.py` - логика формирования команд
- `collect_season_stats.py` - сбор статистики за сезон

### 3. Данные
Проект использует следующие файлы данных:
- `data/processed/player_stats.json` - статистика игроков
- `data/processed/season_stats.json` - статистика за сезон
- `data/processed/teams_history.json` - история команд
- `data/processed/weekly_team_stats.json` - статистика команд по неделям
- `data/photos/` - фотографии игроков
- `data/collages/` - сгенерированные коллажи

## Основные функции

### Формирование команды дня
1. Получение статистики игроков за день через ESPN API
2. Проверка уникальности и корректности данных
3. Выбор лучших игроков по total points
4. Состав команды:
   - 1 центральный нападающий (C)
   - 1 левый нападающий (LW)
   - 1 правый нападающий (RW)
   - 2 защитника (D)
   - 1 вратарь (G)

### Формирование команды недели
1. Анализ статистики игроков из ежедневных данных
2. Приоритеты при выборе игроков:
   - Первый приоритет: количество попаданий в команду дня
   - Второй приоритет: total points
3. Создание отдельного коллажа

### Система грейдов
- Грейды сбрасываются каждую неделю (понедельник-воскресенье)
- Уровни грейдов:
  - common (1 попадание)
  - uncommon (2 попадания)
  - rare (3 попадания)
  - epic (4 попадания)
  - legend (5+ попаданий)

## Настройка проекта

### Конфигурация
1. Переменные окружения (.env):
```
TELEGRAM_BOT_TOKEN=your_bot_token
TELEGRAM_CHAT_ID=your_chat_id
ESPN_SWID={your-swid}
ESPN_S2=your-s2-token
SEASON_ID=2025
LEAGUE_ID=your_league_id
SEASON_START_DATE=2024-10-04
SEASON_END_DATE=2025-04-15
```

2. Конфигурационные файлы:
- `config/settings.py` - основные настройки
- `config/api_config.py` - настройки API
- `config/logging_config.py` - настройки логирования

### Режимы запуска
```bash
# Сбор статистики за день
python scripts/collect_and_send_stats.py --date YYYY-MM-DD

# Перезапись статистики
python scripts/rewrite_all_stats.py  # вся статистика с начала сезона
python scripts/rewrite_all_stats.py --date YYYY-MM-DD  # статистика за конкретную дату

# Формирование команды недели
python scripts/send_daily_teams.py --week YYYY-MM-DD
```

## Рекомендации по разработке

### Первые шаги
1. Изучите структуру проекта и существующий код
2. Проверьте работу с API ESPN
3. Ознакомьтесь с форматом данных и логикой формирования команд

### Улучшения
1. Добавьте обработку ошибок:
   - Повторные попытки при сбоях API
   - Валидация данных
   - Логирование ошибок

2. Оптимизируйте работу с данными:
   - Кэширование запросов
   - Эффективное хранение статистики
   - Очистка устаревших данных

3. Улучшите визуализацию:
   - Качество коллажей
   - Форматирование сообщений
   - Дополнительная статистика

### Тестирование
1. Модульные тесты:
   - Тесты сервисов
   - Тесты формирования команд
   - Тесты обработки данных

2. Интеграционные тесты:
   - Работа с API
   - Отправка сообщений
   - Сохранение данных

## Известные проблемы

1. API ESPN:
   - Необходимость обновления токенов
   - Специальные заголовки
   - SSL-сертификаты

2. Данные:
   - Валидация статистики
   - Обработка пропущенных данных
   - Согласованность истории

3. Производительность:
   - Оптимизация запросов
   - Кэширование
   - Обработка больших объемов данных 