# Руководство по проекту Fantasy Hockey Bot

## Описание проекта

Fantasy Hockey Bot - это автоматизированная система для сбора и анализа статистики игроков НХЛ. Бот ежедневно собирает данные через ESPN API, анализирует выступления игроков и формирует команды из лучших игроков за день или произвольный период.

## Доступ к API

### ESPN API

- Базовый URL: `https://lm-api-reads.fantasy.espn.com/apis/v3/games/fhl/seasons/{season}/segments/0/leagues/{league_id}`
- Необходимые заголовки:
  - Cookie с `SWID` и `espn_s2`
  - `x-fantasy-source: kona`
  - `x-fantasy-filter` для фильтрации данных

### Конфигурация

Все конфиденциальные данные и настройки хранятся в файле `.env`:
```
TELEGRAM_BOT_TOKEN=your_bot_token
TELEGRAM_CHANNEL_ID=your_channel_id
ESPN_SWID={your-swid}
ESPN_S2=your-s2-token
SEASON_ID=2025
LEAGUE_ID=your_league_id
SEASON_START_DATE=2024-10-04
SEASON_END_DATE=2025-04-15
```

## Основные компоненты

### ESPNService

- Отвечает за взаимодействие с ESPN API
- Получает ежедневную статистику игроков
- Обрабатывает и фильтрует данные
- Кэширует результаты для оптимизации

### ImageService

- Загружает и кэширует фотографии игроков
- Создает коллажи команд дня/периода
- Оптимизирует изображения
- Управляет хранением медиафайлов

### TelegramService

- Отправляет сообщения в Telegram канал
- Форматирует текстовые сообщения
- Отправляет коллажи и медиафайлы
- Обрабатывает ошибки отправки

## Система оценки игроков

### Критерии оценки

- Голы: 3 очка
- Передачи: 2 очка
- Броски по воротам: 0.5 очка
- Силовые приемы: 0.2 очка
- Блокированные броски: 0.5 очка
- Штрафные минуты: 0.2 очка

### Грейды игроков

- common: 1 попадание в команду
- uncommon: 2 попадания
- rare: 3 попадания
- epic: 4 попадания
- legend: 5+ попаданий

Грейды обновляются еженедельно.

## Хранение данных

### Структура данных

```
data/
├── collages/           # Сгенерированные коллажи
│   ├── team_of_day_*  # Коллажи команд дня
│   └── team_of_week_* # Коллажи команд периода
├── history/           # История выбранных игроков
│   └── history.json   # Файл с историей
└── photos/           # Фотографии игроков
    └── cached/       # Кэшированные фото
```

### Форматы файлов

- История: JSON
- Изображения: PNG/JPEG
- Логи: текстовые файлы

## Скрипты

### app_day.py

- Обработка ежедневной статистики
- Формирование команды дня
- Отправка результатов в Telegram

### rewrite_all_stats.py

- Обработка статистики за период
- Формирование команд за произвольный период
- Массовая обработка данных

## Известные проблемы

1. API ESPN:
   - Требуются специальные заголовки
   - Возможны проблемы с SSL
   - Ограничения на количество запросов

2. Обработка данных:
   - Пропуски в статистике
   - Несоответствия в именах игроков
   - Задержки в обновлении данных

## Рекомендации по развитию

1. Улучшения API:
   - Добавить кэширование запросов
   - Реализовать автоматическое обновление токенов
   - Улучшить обработку ошибок

2. Функциональность:
   - Добавить интерактивные команды
   - Реализовать веб-интерфейс
   - Расширить систему оценки

3. Оптимизация:
   - Улучшить алгоритмы выбора игроков
   - Оптимизировать хранение данных
   - Добавить мониторинг производительности

4. Тестирование:
   - Добавить модульные тесты
   - Реализовать интеграционные тесты
   - Настроить CI/CD 