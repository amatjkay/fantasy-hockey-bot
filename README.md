# Fantasy Hockey Bot

Бот для сбора статистики хоккейных матчей и формирования команд дня/недели с публикацией в Telegram.

## Особенности

- Сбор статистики игроков через ESPN API
- Формирование команды дня и недели
- Создание коллажей с фотографиями игроков
- Публикация результатов в Telegram
- Хранение истории команд и статистики
- Система грейдов игроков
- Автоматическое обновление статистики

## Требования

- Python 3.8+
- Необходимые Python-пакеты (установка через pip):
  ```
  python-telegram-bot
  requests
  Pillow
  python-dotenv
  pytz
  ```

## Установка

1. Клонируйте репозиторий:
```bash
git clone https://github.com/yourusername/fantasy-hockey-bot.git
cd fantasy-hockey-bot
```

2. Создайте виртуальное окружение и установите зависимости:
```bash
python -m venv venv
source venv/bin/activate  # Linux/Mac
# или
venv\Scripts\activate  # Windows
pip install -r requirements.txt
```

3. Создайте файл `.env` с необходимыми переменными окружения:
```
TELEGRAM_BOT_TOKEN=your_bot_token
TELEGRAM_CHAT_ID=your_chat_id
ESPN_SWID={your-swid}
ESPN_S2=your-s2-token
SEASON_ID=2025
LEAGUE_ID=your_league_id
SEASON_START_DATE=2024-10-04
SEASON_END_DATE=2025-04-15
```

## Использование

### Сбор статистики за день

```bash
python scripts/collect_and_send_stats.py --date YYYY-MM-DD [--no-send]
```

### Перезапись статистики

```bash
# Перезапись всей статистики с начала сезона
python scripts/rewrite_all_stats.py

# Перезапись статистики за конкретную дату
python scripts/rewrite_all_stats.py --date YYYY-MM-DD
```

### Формирование команды недели

```bash
python scripts/send_daily_teams.py --week YYYY-MM-DD [--no-send]
```

## Структура проекта

```
fantasy-hockey-bot/
├── data/                  # Директория для данных
│   ├── processed/        # Обработанные данные
│   ├── photos/          # Фотографии игроков
│   └── collages/        # Сгенерированные коллажи
├── src/                  # Исходный код
│   ├── services/        # Сервисы для работы с API и данными
│   └── utils/           # Вспомогательные функции
├── scripts/              # Скрипты для запуска
└── tests/                # Тесты
```

## Технические детали

### ESPN API

- Базовый URL: `https://lm-api-reads.fantasy.espn.com/apis/v3/games/fhl/seasons/{season}/segments/0/leagues/{league_id}`
- Необходимы заголовки:
  - Cookie с `SWID` и `espn_s2`
  - `x-fantasy-source: kona`
  - `x-fantasy-filter` для фильтрации данных

## Система грейдов

- common (1 попадание в команду дня)
- uncommon (2 попадания)
- rare (3 попадания)
- epic (4 попадания)
- legend (5+ попаданий)

Грейды сбрасываются каждую неделю (с понедельника по воскресенье).

## Хранение данных

- Статистика и оценки игроков хранятся в JSON-файлах в директории `data/processed/`
- Фотографии игроков сохраняются в `data/photos/`
- Ежедневные коллажи сохраняются в `data/collages/`
- Логи записываются в директорию `logs/`

## Советы для следующего ИИ

1. Текущий статус:
- Реализована базовая структура проекта
- Настроена работа с ESPN API
- Реализовано формирование команд дня и недели
- Настроено логирование
- Добавлена система грейдов
- Реализовано автоматическое обновление статистики

2. Следующие шаги:
- Улучшить обработку ошибок при работе с API
- Добавить кэширование запросов к API
- Реализовать сохранение фотографий игроков
- Добавить тесты для основных компонентов
- Улучшить форматирование сообщений для Telegram
- Добавить мониторинг состояния бота
- Реализовать автоматическое обновление токенов ESPN

3. Известные проблемы:
- API ESPN требует специальные заголовки для аутентификации
- Необходимо правильно формировать фильтры для получения статистики
- Возможны проблемы с SSL-сертификатами при запросах

4. Рекомендации:
- Использовать логирование для отладки запросов к API
- Проверять наличие всех необходимых заголовков
- Реализовать механизм повторных попыток при сбоях API
- Добавить валидацию данных от API
